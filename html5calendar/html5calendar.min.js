/*!
 * HTML5Calendar v0.0.1-alpha1
 * Docs & License: https://github.com/scottpledger/html5calendar
 * (c) 2014 Scott Pledger
 */
(function(t){"function"==typeof define&&define.amd?define(["jquery","moment"],t):t(jQuery,moment)})(function(t,e){var s;s=function(){function s(a){var i,n,h;for(h in s.defaults)this[h]=s.defaults[h];if(t.isPlainObject(a)){for(h in a)"start"==h?i=a[h]:"end"==h?n=a[h]:this[h]=a[h];this.element=t("<li></li>")}else{if("object"!=t.type(t(a)[0]))throw Error("Invalid Event!");var o,r,d=t(a),l=d[0].attributes;if(d.data("event")&&null!=d.data("event"))return d.data("event");for(var h=0;l.length>h;h++)o=l[h],o.name.slice(0,s.attrPrefix.length)==s.attrPrefix&&(r=o.name.slice(s.attrPrefix.length),"start"==r?i=o.value:"end"==r?n=o.value:this[o.name.slice(s.attrPrefix.length)]=o.value);this.element=d,d.attr("draggable")?(d.attr("draggable",!1),this.movable=!0):this.movable=!1,d.attr("resizable")?(d.attr("resizable",!1),this.resizable=!0):this.resizable=!1}if(i=e(i),n=e(n),!i.isValid())throw Error("Invalid Event!");if(this.start=i,n.isValid()&&(this.end=n,this.end.isBefore(this.start)))throw Error("Invalid Event!");this.allDay&&(this.start.startOf("day"),this.end=e(i).endOf("day")),this.html&&this.element.html(this.html),this.resizable&&this.element.append('<hr class="ht5c-event-resizeHandle">'),this.element.addClass("ht5c-event"),this.element.data("event",this),this._segments=[]}return s.prototype=e.range(0,1),s.prototype.constructor=s,s.attrPrefix="data-calendar-event-",s.prototype._rmSegments=function(){t(this._segments).each(function(e,s){t(s).remove()}),this._segments=[]},s.prototype._getSegment=function(){var t=this.element.clone();return t.data("event",this),this._segments.push(t),t},s.prototype.makeSegments=function(s){this._rmSegments();var a,i,n,h,o,r,d=this.chunk("into"+s);this.element.find('[data-calendar-event-receive="timeSpan"]').html(this.format());for(a in d)i=d[a],o=i.start,r=i.end,n=this._getSegment(),h=o.diff(e(o).startOf("day"),"hours",!0),n.data("range",i),n.data("dimensions",{top:h,height:r.diff(o,"hours",!0)});return t(this._segments)},s.prototype.redraw=function(){this.element.find('[data-calendar-event-receive="timeSpan"]').html(this.format()),t(this._segments).find('[data-calendar-event-receive="timeSpan"]').html(this.format())},s.prototype.clone=function(){var t,e,a=this.element.clone();a.attr("data-calendar-event-start",this.start.format()),a.attr("data-calendar-event-end",this.end.format()),a.attr("data-calendar-event-allDay",this.allDay),t=new s(a);for(e in this._segments)t._segments.push(this._segments[e].clone());return t},s.prototype.show=function(){t(this._segments).each(function(e,s){t(s).css("display","block")})},s.prototype.hide=function(){t(this._segments).each(function(e,s){t(s).css("display","none")})},s.prototype.addClass=function(){return t.fn.addClass.apply(this.element,Array.prototype.slice.apply(arguments,[0])),t.fn.addClass.apply(t(this._segments),Array.prototype.slice.apply(arguments,[0])),this},s.prototype.removeClass=function(){return t.fn.removeClass.apply(this.element,Array.prototype.slice.apply(arguments,[0])),t.fn.removeClass.apply(t(this._segments),Array.prototype.slice.apply(arguments,[0])),this},s.prototype.add=function(){this.start.add(arguments[0],arguments[1]),this.end.add(arguments[0],arguments[1])},s.prototype.update=function(){},s.prototype.remove=function(){this.element.remove(),t(this._segments).each(function(e,s){t(s).remove()})},s.defaults={allDay:!1},s}(),t.widget("custom.html5calendar",t.ui.mouse,{options:{dayBegin:"09:00:00",dayEnd:"21:00:00",slotDuration:"00:30:00",now:"today",defaultDate:"today",daysPerWeek:7,firstDay:0,rowLabelFormat:"h a",dayLabelFormat:"M/D",monthLabel:"MMM YYYY",view:"month"},_create:function(){var e=this;this.element.addClass("html5calendar"),this._getOptionsFromElement(),this.weekOffset=0,this.today=this._momentizeOption(this.options.now),this.defaultDate=this._momentizeOption(this.options.defaultDate),this.innerElement=this.element.find(".ht5c-inner"),0===this.innerElement.length&&(this.innerElement=t('<div class="ht5c-inner"></div>'),this.element.append(this.innerElement)),this.viewContainer=t('<div class="ht5c-view"></div>'),this.weeksList=t('<ul class="ht5c-weeks"></ul>'),this.hourRows=t('<ul class="ht5c-hours"><li></li></ul>'),this.days={},this.weeks={},this.colWidth=100/this.options.daysPerWeek,this.hourHeight=0,this.innerElement.append(this.hourRows),this.innerElement.append(this.viewContainer),this.viewContainer.append(this.weeksList),this.eventData=this.element.find("[data-calendar-events]"),this.today.startOf("day"),this.element.find("[data-calendar-action]").on("click",function(){var s=t(this);e.element.html5calendar(s.attr("data-calendar-action"))}),this.element.find("[data-calendar-option]").on("click",function(){var s=t(this);e.element.html5calendar("option",s.attr("data-calendar-option"),s.attr("data-calendar-optionValue"))}),this._parseEvents(),this.innerElement.removeClass("agenda basic month").addClass(this.options.view),this.element.removeClass("ht5c-agenda ht5c-basic ht5c-month").addClass("ht5c-"+this.options.view),this.relayout(),this._mouseInit()},_momentizeOption:function(t){return"today"==t?e():e(t)},_getOptionsFromElement:function(){var t;for(var e in this.options)t=this.element.attr("data-calendar-"+e.toLowerCase()),void 0!==t&&(this.options[e]=t)},_parseEvents:function(){var t=this,a=e.duration(this.options.dayBegin),i=e.duration(this.options.dayEnd),n=i.subtract(a).asHours();this._hourBegin=a,this._hourEnd=i,this._maxHeight=n,this.innerElement.removeClass("days-1 days-2 days-3 days-4 days-5 days-6 days-7").addClass("days-"+this.options.daysPerWeek),this.eventData.children("li").each(function(e,a){var i=new s(a);t._placeEvent(i)})},_placeEvent:function(e){var s=e.makeSegments("days"),a=this;s.each(function(e,s){var i,n,h,o,r=t(s);r.appendTo(a._getDay(r.data("range").start)),i=r.data("dimensions"),n=i.top-a._hourBegin.asHours(),h=i.height,0>n&&(n=0,h+=n),h=Math.min(a._maxHeight,h),o={top:n+"em",height:h+"em"},r.data("css",o),r.css("agenda"==a.options.view?o:{top:"0em",height:"auto"})}),e.redraw()},_getWeek:function(s){s=e(s).startOf("week");var a=s.format("YYYYww");if(void 0!==this.weeks[a])return this.weeks[a];var i,n=t('<ul data-calendar-weekLabel="'+a+'" class="ht5c-days"></ul>'),h=t('<li class="ht5c-week"></li>');this.weeks[a]=n,n.data("date",s),h.data("diff",s.diff(e(this.today).startOf("week"),"weeks",!0)),h.append(n),this._populateWeek(n,s);for(i in this.weeks)if(i>a)return this.weeks[i].parent().before(h),n;return this.weeksList.append(h),n},_populateWeek:function(t,s){var a,i=e(s);for(a=0;this.options.daysPerWeek>a;a++)t.append(this._makeDay(i)),i.add(1,"days")},_makeDay:function(s){var a=e(s),i=a.format("YYYYDDDD"),n=n=a.format(this.options.dayLabelFormat),h=t('<ul data-calendar-dayLabel="'+n+'" class="ht5c-events"></ul>'),o=t('<li class="ht5c-day year-'+a.format("YYYY")+" month-"+a.format("M")+" day-"+a.format("D")+'"><time>'+n+"</time></li>");return o.append(h),this.days[i]=h,o},_getDay:function(t){var s=e(t).startOf("day"),a=s.format("YYYYDDDD"),i=this._getWeek(s);if(void 0!==this.days[a])return this.days[a];var n=this._makeDay(s);i.append(n);for(k in i.days)k>dayLabel&&i.days[k].parent().before(n);return day},_layoutHourRows:function(){var s=e(this.today).startOf("day").add(e.duration(this.options.dayBegin)),a=e.duration(this.options.slotDuration),i=e(s).startOf("day").add(e.duration(this.options.dayEnd)),n="",h=a.asHours(),o=0;for(this.hourSize=h;s.isBefore(i)&&100>o;){var r=t('<li class="ht5c-hour"></li>'),d="<time>"+s.format(this.options.rowLabelFormat)+"</time>";d!=n&&r.append(d),n=d,this.hourRows.append(r),r.css({top:o*h+"em",height:h+"em","line-height":h+"em"}),this.hourHeight=r.height(),s.add(a),o++}this.innerElement.data("hours-height",.5+o*h)},_layoutDays:function(){var t,s=e(this.defaultDate),a=e(s),i=(e.duration(1,"day"),0);for(i=0;this.options.daysPerWeek>i;i++)t=this._getDay(a),this.dayHeight=t.parent("li").height(),a=e(a).add(1,"days")},_layoutWeeks:function(){this.defaultDate.startOf("week").add(this.options.firstDay,"day"),this._layoutDays(),this.innerElement.css("height",this.innerElement.data("hours-height")+"em")},_layoutMonths:function(){var t=e(this.defaultDate),s=e(this.defaultDate).endOf("month"),a=1;for(this.defaultDate.startOf("month");this.defaultDate.isBefore(s);)this._layoutWeeks(),this.defaultDate.add(1,"week"),a++;this.defaultDate=t,this.innerElement.css("height",a-1+"em")},_updateWeeks:function(){var t;for(var e in this.weeks)t=this.weeks[e].parent(),t.css("agenda"==this.options.view?{left:100*t.data("diff")+"%",top:0}:{left:0,top:t.data("diff")+"em"})},_updateEvents:function(){var e=this;this.innerElement.find("li.ht5c-event").each(function(s,a){var i=t(a);i.css("agenda"==e.options.view?i.data("css"):{top:"0em",height:"auto"})})},_updateView:function(){var t=e(this.defaultDate);this._updateEvents(),"agenda"==this.options.view?(this.element.find('[data-calender-receive="defaultDate"]').html(e.range(t.startOf("week"),e(t).add(this.options.daysPerWeek-1,"days")).format({__default__:["MMM D","MMM D YYYY"]})),this._layoutWeeks(),this._updateWeeks(),this.weeksList.css({top:0,left:e(this.today).startOf("week").diff(e(this.defaultDate).startOf("week"),"days")*this.colWidth+"%"})):"basic"==this.options.view?(this.element.find('[data-calender-receive="defaultDate"]').html(e.range(t,e(t).add(this.options.daysPerWeek,"days")).format({__default__:["MMM D","MMM D YYYY"]})),this._layoutWeeks(),this._updateWeeks(),this.weeksList.css({top:0,left:e(this.today).startOf("week").diff(e(this.defaultDate).startOf("week"),"days")*this.colWidth+"%"})):"month"==this.options.view&&(this.element.find('[data-calender-receive="defaultDate"]').html(t.format(this.options.monthLabel)),this.element.removeClass("month-1 month-2 month-3 month-4 month-5 month-6 month-7 month-8 month-9 month-10 month-11 month-12").addClass("month-"+this.defaultDate.format("M")),this._layoutMonths(),this._updateWeeks(),this.weeksList.css({left:0,top:e(this.today).startOf("week").diff(e(this.defaultDate).startOf("month").startOf("week"),"weeks")+"em"}))},_setOption:function(t,e){this._super(t,e),("view"==t||"defaultDate"==t)&&(this.innerElement.removeClass("agenda basic month").addClass(this.options.view),this.element.removeClass("ht5c-agenda ht5c-basic ht5c-month").addClass("ht5c-"+this.options.view),this._updateView())},_getMouseTargetEvent:function(e){var s=t(e.target);return s.is(".ht5c-event")?s.data("event"):(s=s.parents(".ht5c-event"),1==s.length?s.data("event"):function(t){return t}())},_getMouseTarget:function(e){var s=t(e.target);return s.is(".ht5c-event")&&s.data("event").movable?s:s.is(".ht5c-event-resizeHandle")?s:(s=s.parents(".ht5c-event"),1==s.length?s:t([]))},_mouseCapture:function(t){var e=this._getMouseTargetEvent(t);if(this._mouseAction)return!1;if(void 0!==e&&(e.movable||e.resizable)){var s=this._getMouseTarget(t);return this._mouseType="move",s.is(".ht5c-event-resizeHandle")&&e.resizable&&(this._mouseType="resize"),this.hourHeight=this.element.find(".ht5c-hour").first().height(),this.dayHeight=this.element.find(".ht5c-day").first().height(),!0}return!1},_mouseStart:function(t){var e=this.viewContainer.width()/this.options.daysPerWeek;this._mouseAction=!0,this._handle=this._getMouseTarget(t),this._event=this._getMouseTargetEvent(t),this._clone=this._event.clone(),this._clone.addClass("ht5c-event-placeholder ht5c-event-clone").removeClass("ht5c-event"),this._placeEvent(this._clone),this._gridSize="agenda"==this.options.view?[e,this.hourHeight]:[e,this.dayHeight],this._factors="agenda"==this.options.view?[24,this.hourSize]:[24,168],this._initX=t.clientX,this._initY=t.clientY,this._change=0,this._event.hide()},_mouseGetChange:function(t){var e=t.clientX-this._initX,s=t.clientY-this._initY,a=Math.round(e/this._gridSize[0])*this._factors[0],i=Math.round(s/this._gridSize[1])*this._factors[1];return a+i},_mouseDrag:function(t){var s=this._mouseGetChange(t);this._clone.start=e(this._event.start),this._clone.end=e(this._event.end),"move"==this._mouseType?this._clone.add(s,"hours"):(this._clone.end.add(s,"hours"),this._clone.end.isBefore(this._clone.start)&&(this._clone.end=e(this._clone.start).add(this.hourSize,"hours")),this._clone.update()),this._placeEvent(this._clone)},_mouseStop:function(t){var s=this._mouseGetChange(t);"move"==this._mouseType?this._event.add(s,"hours"):(this._event.end.add(s,"hours"),this._event.end.isBefore(this._event.start)&&(this._event.end=e(this._event.start).add(this.hourSize,"hours")),this._event.update()),this._event.show(),this._placeEvent(this._event),this._clone.remove(),this._clone=null,this._event=null,this._mouseAction=!1},relayout:function(){this._layoutHourRows(),this._updateView()},next:function(){var t=Array.prototype.slice.apply(arguments,[0]),e="month"==this.options.view?"months":"weeks";0===t.length?this.defaultDate.add(1,e):this.defaultDate.add.apply(this.defaultDate,t),this._updateView()},prev:function(){var t=Array.prototype.slice.apply(arguments,[0]),e="month"==this.options.view?"months":"weeks";0===t.length?this.defaultDate.subtract(1,e):this.defaultDate.subtract.apply(this.defaultDate,t),this._updateView()}}),t('[data-calendar="html5"]').html5calendar()});